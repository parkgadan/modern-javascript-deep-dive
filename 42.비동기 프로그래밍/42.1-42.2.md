# 42장 비동기 프로그래밍


## 목차

- [42.1 동기 처리와 비동기 처리](#42.1)
- [42.2 이벤트 루프와 태스크 큐](#42.2)


## 42.1 동기 처리와 비동기 처리<a name="42.1"></a>

- 함수의 실행 순서는 실행 컨텍스트 스택으로 관리함
	- 실행 컨텍스트 스택에 함수 실행 컨텍스트가 푸시되는 것은 바로 함수 실행의 시작을 의미

- 자바스크립트 엔진은 하나의 실행 컨텍스트 스택을 갖으며, 한 번에 하나의 태스크만 실행할 수 있는 싱글 스레드 방식으로 동작함
	- 함수를 실행할 수 있는 창구가 하나
	- 동시에 2개 이상의 함수를 동시에 실행할 수 없
	- 실행 중인 실행 컨텍스트(최상위 요소)를 제외한 모든 실행 컨텍스트는 모두 실행 대기 중인 태스크들

- 싱글 스레드 방식
	- 한 번에 하나의 태스크만 실행할 수 있음
	- 처리에 시간이 걸리는 태스크를 실행하는 경우 블로킹(작업 중단) 발생함

- 동기 처리
	- 현재 실행 중인 태스크가 종료할 때까지 다음에 실행될 태스크가 대기하는 방식
	- 태스크를 순서대로 하나씩 처리하므로 실행 순서가 보장됨
	- 태스크가 종료할 때까지 이후 태스크들이 블로킹됨

- 비동기 처리
	- 현재 실행 중인 태스크가 종료 되지 않은 상태라 해도 다음 태스크를 곧바로 실행하는 방식
	- 블로킹이 발생하지 않음
	- 태스크의 실행 순서가 보장되지 않음
	- 비동기 함수는 콜백 패턴을 사용
	- 타이머 함수인 setTimeout과 setinterval, HTTP 요청, 이벤트 핸들러는 비동기 처리 방식으로 동작함
	- 이벤트 루프와 태스크 큐와 관계 있음

```js
// sleep 함수는 일정 시간이 경과한 이후에 콜백 함수 호출
function sleep(func, delay) {
	// Date.now()는 현재 시간을 숫자로 반환
	const delayUntil = Date.now() + delay;

	// 현재 시간(Date.now())에 delay를 더한 delayUntil이 현재 시간보다 작으면 계속 반복함
	while (Date.now() < delayUntil);
	// 일정 시간(delay)이 경과한 이후에 콜백 함수 호출
	func();
}

function foo() { 
	console.log('foo');
}

function bar() { 
	console.log('bar');
}

// sleep 함수는 3초 이상 실행
sleep(foo, 3 * 1000);

// bar 함수는 sleep 함수의 실행이 종료된 이후에 호출되므로 3초 이상 블로킹됨 
bar();
// (3초 경과 후) foo 호출 -> bar 호출
```

```js
// 타이머 함수 setTimeout
function foo() { 
	console.log('foo');
}

function bar() { 
	console.log('bar');
}

// setTimeout 함수는 일정 시간이 경과한 이후에 콜백 함수 foo 호출함 
// setTimeout 함수는 bar 함수를 블로킹하지 않음
setTimeout(foo, 3 * 1000);
bar();
// bar 호출 -> (3초 경과 후) foo 호출
```


## 42.2 이벤트 루프와 태스크 큐<a name="42.2"></a>

- 이벤트 루프
	- 동시성 지원(ex. HTML 요소의 애니메이션 효과 및 이벤트 처리, HTTP 요청을 통한 서버에서 데이터를 가져와 렌더링 등)
	- 브라우저에 내장되어 있는 기능 중 하나

- 자바스크립트 엔진
	- 2개의 영역(콜 스택, 힙)으로 크게 구분할 수 있음
	- 태스크가 요청되면 콜 스택을 통해 요청된 작업을 순차적으로 실행함
	- 브라우저에 내장된 자바스크립트 엔진은 싱글 스레드 방식, 브라우저는 멀티 스레드로 동작함

- 브라우저, Node.js(자바스크립트 엔진 구동 환경)
	- 비동기 처리에서 소스코드의 평가와 실행을 제외한 모든 처리를 담당
	- 태스크 큐와 이벤트 루프 제공

- 콜 스택
	- 소스코드(전역 코드나 함수 코드 등) 평가 과정에서 생성된 실행 컨텍스트가 추가되고 제거되는 스택 자료구조인 실행 컨텍스트 스택

- 힙
	- 객체가 저장되는 메모리 공간
	- 실행 컨텍스트(콜 스택의 요소)는 힙에 저장된 객체를 참조

- 태스크 큐
	- 비동기 함수의 콜백 함수 또는 이벤트 핸들러가 일시적으로 보관되는 영역

- 이벤트 루프
	- 콜스택에 현재 실행 중인 실행 컨텍스트가 있는지, 태스크 큐에 대기 중인 함수(콜백 함수, 이벤트 핸들러 등)가 있는지 반복해서 확인함