# 45장 프로미스


## 목차

- [45.1 비동기 처리를 위한 콜백 패턴의 단점](#45.1)
- [45.2 프로미스의 생성](#45.2)
- [45.3 프로미스의 후속 처리 메서드](#45.3)
- [45.4 프로미스의 에러 처리](#45.4)
- [45.5 프로미스 체이닝](#45.5)
- [45.6 프로미스의 정적 메서드](#45.6)
- [45.7 마이크로태스크 큐](#45.7)
- [45.8 fetch](#45.8)


## 45.1 비동기 처리를 위한 콜백 패턴의 단점<a name="45.1"></a>

### 45.1.1 콜백 헬

- 비동기 함수를 호출하면 함수 내부의 비동기로 동작하는 코드가 완료되지 않았다 해도 기다리지 않고 즉시 종료됨
  - 비동기 함수 내부의 비동기로 동작하는 코드는 비동기 함수가 종료된 이후에 완료됨
  - 비동기 함수 내부의 비동기로 동작하는 코드에서 처리 결과를 외부로 반환하거나 상위 스코프의 변수에 할당 하면 기대한 대로 동작하지 않음

- 비동기 함수는 비동기 처리 결과를 외부에 반환할 수 없고 상위 스코프의 변수에 할당할 수도 없음

- 비동기 함수의 처리 결과(서버의 응답 등)에 대한 후속 처리는 비동기 함수 내부에서 수행해야 함

- 비동기 함수를 범용적으로 사용하기 위해 비동기 함수에 비동기 처리 결과에 대한 후속 처리를 수행하 는 콜백 함수를 전달하는 것이 일반적임

- 필요에 따라 비동기 처리가 성공하면 호출될 콜백 함수와 비동기 처리가 실패하면 호출될 콜백 함수를 전달할 수 있음

- 콜백 헬: 비동기 함수를 호출해야 한다면 콜백 함수 호출이 중첩되어 복잡도가 높아지는 현상이 발생함

### 45.1.2 에러 처리의 한계

- 비동기 처리를 위한 콜백 패턴의 문제점 중에서 가장 심각한 것은 에러 처리 곤란

- `try... catch... finally 문`
  - 에러 처리를 구현하는 방법
  - `try... catch... finally` 문으로 에러를 처리하면 프로그램이 강제 종료되지 않음

- 에러는 호출자 방향으로 전파됨


## 45.2 프로미스의 생성<a name="45.2"></a>

- `Promise` 생성자 함수를 `new` 연산자와 함께 호출하면 프로미스 생성
  - `Promise는` 호스트 객체가 아닌 ECMAScript 사양에 정의된 표준 빌트인 객체

- `Promise` 생성자 함수는 비동기 처리를 수행할 콜백 함수를 인수로 전달받는데 이 콜백 함수는 `resolve`와 `reject` 함수를 인수로 전달받음

|프로미스의 상태 정보|의미|상태 변경 조건|
|--|--|--|
|pending|비동기 처리가 아직 수행되지 않은 상태|프로미스가 생성된 직후 기본 상태|
|fulfilled|비동기 처리가 수행된 상태(성공)|resolve 함수 호출|
|rejected|비동기 처리가 수행된 상태(실패)|reject 함수 호출|

- 생성된 직후 프로미스는 기본적으로 `pending` 상태
  - 비동기 처리가 수행되면 비동기 처리 결과에 따라 프로미스 상태가 변경됨

- 비동기 처리 상태와 처리 결과를 관리하는 객체


## 45.3 프로미스의 후속 처리 메서드<a name="45.3"></a>

- 프로미스의 비동기 처리 상태가 변화하면 후속 처리 메서드에 인수로 전달한 콜백 함수가 선택적으로 호출됨

- 모든 후속 처리 메서드는 프로미스를 반환하며, 비동기적으로 동작

### 45.3.1 Promise.prototype.then

- `then` 메서드는 두 개의 콜백 함수를 인수로 전달받음
  - 첫 번째 콜백 함수는 비동기 처리가 성공했을 때 호출되는 성공 처리 콜백 함수
  - 두 번째 콜백 함수는 비동기 처리가 실패했을 때 호출되는 실패 처리 콜백 함수

### 45.3.2 Promise.prototype.catch

- `catch` 메서드는 한 개의 콜백 함수를 인수로 전달받음

- `catch` 메서드의 콜백 함수는 프로미스가 `rejected` 상태인 경우에만 호출됨

- `then(undefined, onRejected)`과 동일하게 동작

### 45.3.3 Promise.prototype.finally

- `finally` 메서드는 한 개의 콜백 함수를 인수로 전달받음

- `finally` 메서드의 콜백 함수는 프로미스의 성공 또는 실패와 상관없이 무조건 한 번 호출됨

- `finally` 메서드도 `then/catch` 메서드와 마찬가지로 언제나 프로미스 반환

```js
new Promise(() => {}).finally(() => console.log('finally'));
```


## 45.4 프로미스의 에러 처리<a name="45.4"></a>

- 비동기 처리 결과에 대한 후속 처리는 프로미스가 제공 하는 후속 처리 메서드 `then`, `catch`, `finally` 사용하여 수행
  - `then` 메서드의 두 번째 콜백 함수는 첫 번째 콜백 함수에서 발생한 에러를 캐치하지 못하고 코드가 복잡 해져서 가독성이 좋지 않음 
  - `catch` 메서드를 호출하면 내부적으로 `then(undefined, onRejected)`을 호출 가능하며, `then` 메서드를 호출한 이후에 호출하면 비동기 처리에서 발생한 에러뿐만 아니라 `then` 메서드 내부에서 발생한 에러까지 모두 캐치 가능
  

## 45.5 프로미스 체이닝<a name="45.5"></a>

- `then — then — catch` 순서로 후속 처리 메서드 호출

- `then`, `catch`, `finally` 후속 처리 메서드는 콜백 함수가 반환한 프로미스 반환


## 45.6 프로미스의 정적 메서드<a name="45.6"></a>

### 45.6.1 Promise.resolve / Promise.reject

- 이미 존재하는 값을 래핑하여 프로미스를 생성하기 위해 사용

- `Promise.resolve` 메서드는 인수로 전달받은 값을 `resolve`하는 프로미스 생성

### 45.6.2 Promise.all

- 여러 개의 비동기 처리를 모두 병렬 처리할 때 사용

- `Promise.all` 메서드는 여러 개의 비동기 처리를 모두 병렬 처리할 때 사용

### 45.6.3 Promise.race

- `Promise.all` 메서드와 동일하게 프로미스를 요소로 갖는 배열 등의 이터러블을 인 수 전달

- `Promise.all` 메서드처럼 모든 프로미스가 `fulfilled` 상태가 되는 것을 기다리는 것이 아니라 가장 먼저 `fulfilled` 상태가 된 프로미스의 처리 결과를 `resolve`하는 새로운 프로미스 반환

- 전달된 프로미스가 하나라도 `rejected` 상태가 되면 에러를 `reject`하는 새로운 프로미스 즉시 반환

### 45.6.4 Promise.aTLSettled

- 프로미스를 요소로 갖는 배열 등의 이터러블을 인수 전달

- 전달받은 프로미스가 모두 `settled` 상태(비동기 처리가 수행된 상태)가 되면 처리 결과를 배열 반환

- 반환한 배열에는 `fulfilled` 또는 `rejected` 상태와는 상관없이 `Promise.allSettled` 메서드가 인수로 전달받은 모든 프로미스들의 처리 결과 담김

## 45.7 마이크로태스크 큐<a name="45.7"></a>

- 마이크로태스크 큐에는 프로미스의 후속 처리 메서드의 콜백 함수가 일시 저장되며, 그 외의 비동기 함수의 콜백 함수, 이벤트 핸들러러는 태스크 큐에 일시  저장됨

- 콜백 함수나 이벤트 핸들러를 일시 저장한다는 점에서 태스크 큐와 동일하지만 마이크로태스크 큐는 태스크 큐보다 우선순위가 높음
  - 이벤트 루프는 콜 스택이 비면 먼저 마이크로태스크 큐에서 대기하고 있는 함수를 가져와 실행 후, 마이크로태스크 큐가 비면 태스크 큐에 대기하고 있는 함수를 가져와 실행함


## 45.8 fetch<a name="45.8"></a>

- `XMLHttpRequest` 객체와 마찬가지로 HTTP 요청 전송 기능을 제공하는 클라이언트 사이드 Web API

- `fetch` 함수에는 HTTP 요청을 전송할 URL과 HTTP 요청 메서드, HTTP 요청 헤더, 페이로드 등을 설정한 객체 전달

```js
const promise = fetch(url [, options])
```

- HTTP 응답을 나타내는 `Response` 객체를 래핑한 `Promise` 객체 반환

- 반환하는 프로미스는 기본적으로 `HTTP` 에러가 발생해도 에러를 `reject`하지 않고 불리언 타입의 ok 상태를 `false`로 설정한 Response 객체를 `resolve`함

- 오프라인 등의 네트워크 장애나 CORS 에러에 의해 요청이 완료되지 못한 경우에만 프로미스를 `reject`함