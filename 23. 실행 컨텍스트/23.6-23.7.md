## 23.6 실행 컨텍스트의 생성과 식별자 검색 과정

### 23.6.1 전역 객체 생성

- 전역 객체는 전역 코드가 평가되기 이전에 생성된다.
- 전역 객체에는 빌트인 전역 프로퍼티, 빌트인 전역 함수, 표준 빌트인 객체, 호스트 객체를 포함한다.
- 전역 객체도 Object.prototype을 상속받는다. (프로토타입 체인의 일원이다.)

### 23.6.2 전역 코드 평가

- 소스코드가 로드되면 자바스크립트 엔진은 전역 코드를 평가한다.
- 전역 코드 평가는 다음과 같은 순서로 진행된다.
  1. 전역 **실행 컨텍스트 생성**
  2. 전역 **렉시컬 환경(환경 레코드 / 외부 렉시컬 환경에 대한 참조) 생성**
     1. 전역 **환경 레코드 생성**
        1. **객체** 환경 레코드 생성
           - var 전역 변수, 전역 함수, 빌트인 전역 프로퍼티, 빌트인 전역 함수, 표준 빌트인 객체
           - **`BindingObject`**라고 부르는 객체와 연결된다. **`BindingObject`**를 통해 전역 객체에 변수 식별자를 키로 등록한다.
        2. **선언적** 환경 레코드 생성
           - let, const 키워드로 선언한 전역 변수
     2. this 바인딩
        - 전역 환경 레코드의 [[GlobalThisValue]] 내부슬롯에 this가 바인딩 된다. 일반적으로 전역 코드에서 this는 전역 객체를 가리키므로 **전역 객체**가 바인딩된다.
        - **this 바인딩은 객체 환경 레코드와 선언적 환경 레코드엔 없고, 전역 환경 레코드와 함수 환경 레코드에만 존재한다.**
     3. 외부 렉시컬 환경에 대한 참조 결정
        - 현재 평가 중인 소스코드를 포함하는 외부 소스코드의 렉시컬 환경, 즉 상위 스코프를 가리킨다.
        - 전역 코드는 외부 렉시컬 환경에 대한 참조에 null이 할당된다. (즉, 전역 렉시컬 환경이 스코프 체인의 종점에 존재함을 의미한다.)

### 23.6.3 전역 코드 실행

- **`식별자 결정`**: 동일한 이름의 식별자가 다른 스코프에 여러 개 존재할 수 있다. 어느 스코프의 식별자를 참조하면 되는지 결정하는 것이 식별자 결정이다.
  - 식별자 결정을 위해 식별자를 검색할 때는 실행중인 실행 컨텍스트에서 식별자를 검색하기 시작한다.
  - 식별자는 실행 컨텍스트의 렉시컬 환경의 환경 레코드에 등록되어 있다.

### 23.6.4 foo 함수 코드 평가

```jsx
var x = 1;
const y = 2;

function foo(a) {
  var x = 3;
  const y = 4;

  function bar(b) {
    const z = 5;
    console.log(a + b + x + y + z);
  }

  bar(10);
}

foo(20);
```

- 함수 코드 평가는 다음과 같은 순서로 진행된다.

  1. 함수 **실행 컨텍스트 생성**
  2. 함수 **렉시컬 환경(환경 레코드 / 외부 렉시컬 환경에 대한 참조) 생성**
     1. 함수 **환경 레코드 생성**
        - 매개변수, arguments 객체, 함수 내부에서 선언한 지역 변수와 중첩 함수를 등록하고 관리.
     2. this 바인딩
        - foo 함수는 일반 함수로 호출되었으므로 this는 전역 객체를 가리킨다.
        - 함수 환경 레코드의 [[Thisvalue]] 내부 슬롯에는 전역 객체가 바인딩 된다.
        - foo 함수 내부에서 this를 참조하면 함수 환경 레코드의 [[Thisvalue]] 내부 슬롯에 바인딩 되어 있는 객체가 반환된다.
     3. 외부 렉시컬 환경에 대한 참조 결정
        - foo 함수는 전역 코드에 정의된 전역 함수이다. 따라서 foo 함수 정의는 전역 코드 평가 시점에 평가된다. **외부 렉시컬 환경에 대한 참조에는 전역 렉시컬 환경의 참조가 할당된다.**

- 자바스크립트는 함수를 어디서 호출했는지가 아니라 **어디에 정의했는지에 따라** 상위 스코프를 결정한다. (ref. 13.5)
  - 자바스크립트 엔진은 함수 정의를 평가하여 함수 객체를 생성할 때, 현재 실행 중인 실행 컨텍스트의 렉시컬 환경, 즉 함수의 상위 스코프를 함수 객체의 내부 슬롯 [[Environment]] 에 저장한다.

### 23.6.5 foo함수 코드 실행

```jsx
var x = 1;
const y = 2;

function foo(a) {
  var x = 3;
  const y = 4;

  function bar(b) {
    const z = 5;
    console.log(a + b + x + y + z);
  }

  bar(10);
}

foo(20);
```

- 런타임이 시작되어 foo 함수의 소스코드가 순차적으로 실행된다.
- 매개변수에 인수가 할당되고, 함수 bar가 호출된다.
- 식별자 결정을 위해 실행 중인 실행 컨텍스트의 렉시컬 환경에서 식별자를 검색하기 시작한다. 검색된 식별자에 값을 바인딩한다.

### 23.6.6 bar 함수 코드 평가

- bar 함수가 호출되면 bar 함수 내부로 코드의 제어권이 이동한다. 그리고 bar 함수 코드를 평가하기 시작한다.

### 23.6.7 bar 함수 코드 실행

- 런타임이 시작되어 bar 함수의 소스코드가 순차적으로 실행된다.
- 매개변수에 인수가 할당되고, 지역 변수 z에 값이 할당된다.

### 23.6.8 bar 함수 코드 종료

- bar함수 코드의 실행이 종료되고, bar 함수 실행 컨텍스트가 스택에서 팝되어 제거된다.
- bar 함수 실행 컨텍스트가 소멸되었다 하더라도 **만약 bar 함수 렉시컬 환경을 누군가 참조하고 있다면 bar 함수 렉시컬 환경은 소멸하지 않는다**.

### 23.6.9 foo 함수 코드 종료

### 23.6.10 전역 코드 실행 종료

## 23.7 실행 컨텍스트와 블록 레벨 스코프

- let, const 키워드로 선언한 변수는 모든 코드 블록을 지역 스코프로 인정하는 블록 레벨 스코프를 따른다.
- 코드 블록이 실행될 때마다 코드 블록을 위한 새로운 렉시컬 환경을 생성한다.
